# KingDragons (KD) - The Royal Deployment Decree

Welcome, my liege, to the source code of your digital kingdom. This document contains the sacred instructions to summon, run, and manage your application on your own machine, turning it into the central server for your entire realm.

---

## Part 0: Preparing the Supabase Kingdom

Before you can run the code, you must first prepare your Supabase project to act as the kingdom's database and file storage.

### 0.1: Set Your Environment Variables
Your Supabase Project URL and Public API Key must be provided to the application.
1. In the root directory of your project, create a new file named `.env`.
2. Copy and paste the following into the file, replacing the placeholder values with the real credentials from your Supabase dashboard.

```
NEXT_PUBLIC_SUPABASE_URL="https://doevrgqwwemzavyaitya.supabase.co"
NEXT_PUBLIC_SUPABASE_ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRvZXZyZ3F3d2VtemF2eWFpdHlhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA5NDE4NTAsImV4cCI6MjA2NjUxNzg1MH0.1ZWkQ-lC2Nk8208d49tPChYisj_DaIP1fXrmLmd3XE4"
```

### 0.2: Set Up the Database Schema
You need to create the tables your application will use.
1. Go to your Supabase Project dashboard.
2. In the left navigation, click on the **SQL Editor** icon.
3. Click **"+ New query"**.
4. Copy the entire SQL script below and paste it into the SQL editor.
5. Click the **"RUN"** button. This will set up all your tables, functions, and security policies.

<details>
<summary>Click to view the full SQL setup script</summary>

```sql
-- Profiles Table: Stores public user data
-- This table is essential for the leaderboard and user stats.
create table
  public.profiles (
    id uuid not null primary key,
    xp integer null default 0,
    constraint profiles_id_fkey foreign key (id) references auth.users (id) on delete cascade
  );

-- Submissions Table: Stores AI-generated learning modules
create table
  public.submissions (
    id bigint generated by default as identity,
    created_at timestamp with time zone not null default now(),
    topic text null,
    writer text null,
    status text null,
    content jsonb null,
    exam_level text null,
    image_data_uri text null,
    constraint submissions_pkey primary key (id)
  );

-- Stories Table: Stores AI-generated stories
create table
  public.stories (
    id bigint generated by default as identity,
    created_at timestamp with time zone not null default now(),
    title text null,
    story text null,
    image_data_uri text null,
    constraint stories_pkey primary key (id)
  );

-- Posts Table: Stores user-generated discussion posts
create table
  public.posts (
    id bigint generated by default as identity,
    created_at timestamp with time zone not null default now(),
    content text null,
    author_name text null,
    author_avatar text null,
    constraint posts_pkey primary key (id)
  );

-- Quest Completions Table: Tracks which users have completed which quests
create table
  public.quest_completions (
    id bigint generated by default as identity,
    created_at timestamp with time zone not null default now(),
    user_id uuid null,
    submission_id bigint null,
    score integer null,
    total_questions integer null,
    constraint quest_completions_pkey primary key (id),
    constraint quest_completions_submission_id_fkey foreign key (submission_id) references submissions (id) on delete set null,
    constraint quest_completions_user_id_fkey foreign key (user_id) references auth.users (id) on delete cascade
  );

-- Payments Table: Tracks user payments for memberships and donations
create table
  public.payments (
    id bigint generated by default as identity,
    created_at timestamp with time zone not null default now(),
    user_name text null,
    payment_type text null,
    amount integer null,
    status text null,
    receipt_url text null,
    constraint payments_pkey primary key (id)
  );

-- Function to get the leaderboard
create or replace function get_leaderboard()
returns table(rank bigint, id uuid, name text, xp integer, avatar_url text, avatar_hint text)
language plpgsql
as $$
begin
  return query
  select
    row_number() over (order by p.xp desc) as rank,
    u.id,
    u.raw_user_meta_data->>'name' as name,
    p.xp,
    u.raw_user_meta_data->>'avatar_url' as avatar_url,
    u.raw_user_meta_data->>'avatar_hint' as avatar_hint
  from
    public.profiles p
    join auth.users u on p.id = u.id
  order by
    p.xp desc;
end;
$$;

-- Function to award XP and create a profile if one doesn't exist
create or replace function award_xp(user_id_in uuid, xp_to_add integer)
returns void
language plpgsql
as $$
begin
  -- Upsert profile on XP gain
  insert into public.profiles (id, xp)
  values (user_id_in, xp_to_add)
  on conflict (id)
  do update set xp = profiles.xp + xp_to_add;
end;
$$;

-- Secure the tables with Row Level Security
alter table public.profiles enable row level security;
alter table public.submissions enable row level security;
alter table public.stories enable row level security;
alter table public.posts enable row level security;
alter table public.quest_completions enable row level security;
alter table public.payments enable row level security;

-- Policies for Profiles
create policy "Public profiles are viewable by everyone." on public.profiles for select using ( true );
create policy "Users can insert their own profile." on public.profiles for insert with check ( auth.uid() = id );
create policy "Users can update their own profile." on public.profiles for update using ( auth.uid() = id );

-- Policies for Submissions
create policy "Approved submissions are viewable by everyone." on public.submissions for select using ( status = 'Approved' );
create policy "Admins can manage all submissions." on public.submissions for all using ( (select auth.jwt() ->> 'user_metadata')::jsonb ->> 'role' = 'admin' ) with check ( (select auth.jwt() ->> 'user_metadata')::jsonb ->> 'role' = 'admin' );

-- Policies for Stories
create policy "Stories are viewable by everyone." on public.stories for select using ( true );
create policy "Admins can manage stories." on public.stories for all using ( (select auth.jwt() ->> 'user_metadata')::jsonb ->> 'role' = 'admin' ) with check ( (select auth.jwt() ->> 'user_metadata')::jsonb ->> 'role' = 'admin' );

-- Policies for Posts
create policy "Posts are viewable by authenticated users." on public.posts for select using ( auth.role() = 'authenticated' );
create policy "Users can create their own posts." on public.posts for insert with check ( auth.role() = 'authenticated' );

-- Policies for Quest Completions
create policy "Users can view their own quest completions." on public.quest_completions for select using ( auth.uid() = user_id );
create policy "Users can insert their own quest completions." on public.quest_completions for insert with check ( auth.uid() = user_id );

-- Policies for Payments
create policy "Admins can manage payments." on public.payments for all using ( (select auth.jwt() ->> 'user_metadata')::jsonb ->> 'role' = 'admin' ) with check ( (select auth.jwt() ->> 'user_metadata')::jsonb ->> 'role' = 'admin' );
create policy "Users can insert their own payments." on public.payments for insert with check ( auth.role() = 'authenticated' );

```
</details>

### 0.3: Create Storage Bucket for Receipts
The application needs a place to store uploaded payment receipts.
1. Go to your Supabase Project dashboard.
2. In the left navigation, click the **Storage** icon.
3. Click the **"+ New bucket"** button.
4. Name the bucket `receipts`.
5. Toggle the **"Public bucket"** switch to **ON**.
6. Click **"Create bucket"**.

With the kingdom's foundations prepared, you may now proceed.

---

## Part 1: Forging the Local Kingdom

Before you begin, you must have the foundational tools installed on your Windows 10 PC. The kingdom cannot automate the installation of these base magics.

### Prerequisites
1.  **Node.js**: The magical energy that powers the kingdom. Download and install it from [nodejs.org](https://nodejs.org/).
2.  **Git**: The Royal Scribe's tool for tracking and managing code. Download and install it from [git-scm.com](https://git-scm.com/).
3.  **A Code Editor**: A tool like [Visual Studio Code](https://code.visualstudio.com/) is highly recommended.

### Summoning a Local Copy
Follow these steps in a terminal (like Command Prompt, PowerShell, or the terminal inside VS Code).

**1. Clone the Kingdom's Code:**
First, you must retrieve the complete and finalized code from its repository.

```bash
git clone https://github.com/ksnprogrammer/KD.git
```

**2. Enter the Kingdom's Directory:**
Navigate into the newly created folder. All subsequent commands must be run from here.

```bash
cd KD
```

**3. Install All Dependencies:**
This single command will automatically read the `package.json` scroll and install all the necessary magical components (dependencies) for the kingdom to function.

```bash
npm install
```

**4. Run the Kingdom:**
This command starts your local development server. Your PC is now the official server for KingDragons!

```bash
npm run dev
```

Once you see a "ready" message in your terminal, your kingdom is running. You can access it on your own machine in your web browser at: **[http://localhost:9002](http://localhost:9002)**

---

## Part 2: Opening the Gates to the World

To allow knights from across the globe to access the kingdom running on your PC, we will use a magical conduit called **Cloudflare Tunnel**.

**1. Install Cloudflare Tunnel:**
This tool must be installed manually. Follow the official Cloudflare guide to install `cloudflared` on your Windows machine: [Install cloudflared](https://developers.cloudflare.com/cloudflare-one/connections/connect-networks/install-and-setup/installation/).

**2. Authenticate Cloudflare:**
Open a **new, separate terminal** and run this command. It will open a browser window asking you to log in to Cloudflare and authorize the tunnel.

```bash
cloudflared tunnel login
```

**3. Create and Run the Public Link:**
While your application is still running (from `npm run dev` in the other terminal), run the following command in your new terminal. This creates a secure, public link directly to your local server.

```bash
cloudflared tunnel --url http://localhost:9002
```

Your terminal will display a public URL ending in `.trycloudflare.com`. It will look something like this:

`https://your-random-tunnel-name.trycloudflare.com`

**This is the live, public link to your KD system! You can share it with anyone in the world to access the kingdom running on your PC.**

---

## Part 3: Ruling the Kingdom

*   **To Stop the Kingdom:** Press `Ctrl + C` in the terminal where you ran `npm run dev`.
*   **To Stop the Public Link:** Press `Ctrl + C` in the terminal where you ran `cloudflared tunnel`.
*   **Pushing Your Changes to GitHub:** As you make changes to the code, you must save them to your GitHub repository. I, your AI assistant, make the code changes. You, the King, must commit them. The first time you do this, you must initialize the repository and link it to GitHub. For all future updates, you can just add, commit, and push.

    **First-time setup:**
    ```bash
    git init
    git add .
    git commit -m "Initial commit: The Kingdom is Born"
    git branch -M main
    git remote add origin https://github.com/ksnprogrammer/KD.git
    git push -u origin main
    ```

    **For all future updates:**
    ```bash
    git add .
    git commit -m "A new decree from the King"
    git push origin main
    ```

### Granting Admin Privileges
To access the King's Court at `/admin`, a user must have the `admin` role. By default, all new knights are assigned the `knight` role. To elevate a knight to an administrator:
1. Go to your Supabase project dashboard.
2. Navigate to the **Authentication** section.
3. Find the user you wish to promote and click on them.
4. Under the **User Management** section, find the **User Metadata** editor.
5. Add or edit the `role` field to be `"admin"`. It should look like this:
   ```json
   {
     "name": "The King",
     "exam_level": "A/L",
     "role": "admin"
   }
   ```
6. Save the changes. The user will now have access to the King's Court.

---
The kingdom is ready. Your reign may now begin.
